name: E2E Tests

on:
  push:
  pull_request:

jobs:
  test-e2e:
    name: Run on Self-hosted Linux
    runs-on: [self-hosted, linux, x64]
    steps:

      # Use the runner's default kubeconfig/context; no kind cluster
      - name: Install kubectl if missing (no sudo)
        shell: bash
        run: |
          if ! command -v kubectl >/dev/null 2>&1; then
            echo "kubectl not found; installing locally";
            ver="$(curl -fsSL https://dl.k8s.io/release/stable.txt)";
            curl -fsSL -o "$RUNNER_TEMP/kubectl" "https://dl.k8s.io/release/${ver}/bin/linux/amd64/kubectl";
            chmod +x "$RUNNER_TEMP/kubectl";
            mkdir -p "$HOME/.local/bin";
            mv "$RUNNER_TEMP/kubectl" "$HOME/.local/bin/kubectl";
            echo "$HOME/.local/bin" >> "$GITHUB_PATH";
          else
            echo "kubectl already installed";
          fi

      - name: Show kube context
        run: |
          kubectl config current-context || true
          kubectl cluster-info || true

      - name: Go mod tidy (controlplane)
        working-directory: images/controlplane
        run: go mod tidy

      - name: Go mod tidy (test)
        working-directory: test
        run: go mod tidy

      - name: Run e2e tests
        run: go test ./test/e2e/ -v -ginkgo.v
